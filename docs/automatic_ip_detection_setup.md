# Automatic IP Detection and Startup System

## Overview

The Questa Web Interface now includes an enhanced startup system that automatically detects IP address changes and configures both frontend and backend services accordingly. This eliminates the need for manual configuration when DHCP assigns new IP addresses.

## üöÄ Enhanced Startup Script

### Location
`scripts/start-questa-enhanced.sh`

### Features

1. **Automatic IP Detection**: Detects current network IP address using multiple methods
2. **Network Readiness Check**: Waits for network to be ready before starting services
3. **Dynamic Configuration**: Updates both frontend and backend environment files
4. **Port Availability Check**: Finds available ports if default ports are in use
5. **IP Change Detection**: Detects when IP has changed and updates configuration
6. **Service Management**: Automatically starts/restarts PM2 services
7. **Configuration Persistence**: Saves configuration for future reference

### How It Works

```bash
# 1. Network Detection
üåê Waiting for network to be ready...
‚úÖ Network is ready

# 2. IP Detection
üìç Detected IP: 192.168.10.128

# 3. Port Configuration
üîå Backend Port: 3001
üîå Frontend Port: 3000

# 4. Environment Updates
üîß Updating frontend configuration...
‚úÖ Frontend configuration updated
üîß Updating backend configuration...
‚úÖ Backend configuration updated

# 5. Service Startup
üîÑ Restarting services with new configuration...
‚úÖ Services restarted successfully
```

## üìÅ Configuration Files

### Frontend Environment (`frontend/.env`)
```env
# Auto-generated by startup script
REACT_APP_API_URL=http://192.168.10.128:3001
REACT_APP_WS_URL=ws://192.168.10.128:3001
REACT_APP_HOST_IP=192.168.10.128
REACT_APP_BACKEND_PORT=3001
```

### Backend Environment (`backend/.env`)
```env
# Backend Environment Configuration
# Auto-generated by startup script

# Server Configuration
PORT=3001
HOST=0.0.0.0

# CORS Configuration
CORS_ORIGIN=http://192.168.10.128:3000,http://localhost:3000,http://localhost:3001

# License Configuration
LICENSE_CHECK_INTERVAL=60000

# Logging Configuration
LOG_LEVEL=info
LOG_FILE=./logs/app.log

# Workspace Configuration
WORKSPACE_ROOT=../workspace
PROJECTS_DIR=../workspace/projects
JOBS_DIR=../workspace/jobs
UPLOADS_DIR=./uploads
RESULTS_DIR=./public/results

# Security Configuration
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=1000
SESSION_SECRET=questa-web-interface-secret-change-in-production
```

### Configuration Cache (`.questa-config.json`)
```json
{
  "host_ip": "192.168.10.128",
  "backend_port": "3001",
  "frontend_port": "3000",
  "timestamp": "2025-07-07T11:14:04+09:00",
  "node_env": "development"
}
```

## üîß Usage

### Manual Startup
```bash
# Make script executable (first time only)
chmod +x scripts/start-questa-enhanced.sh

# Start services with automatic IP detection
./scripts/start-questa-enhanced.sh
```

### Automatic Startup on Boot

#### Option 1: Systemd Service (Recommended)
```bash
# Install the systemd service
sudo ./scripts/install-systemd-service.sh

# Enable and start the service
sudo systemctl enable questa-web-interface
sudo systemctl start questa-web-interface

# Check status
sudo systemctl status questa-web-interface
```

#### Option 2: PM2 Startup
```bash
# Start services manually first
./scripts/start-questa-enhanced.sh

# Save PM2 configuration for auto-start
pm2 save
pm2 startup

# Follow the instructions to enable PM2 startup
```

## üîÑ IP Change Handling

### Automatic Detection
The system automatically detects IP changes by:
1. Comparing current IP with cached configuration
2. Updating environment files with new IP
3. Restarting services with new configuration

### Manual Recovery
If automatic detection fails:
```bash
# Force IP update and restart
./scripts/start-questa-enhanced.sh

# Or use the recovery script
./scripts/recover-ip-change.sh
```

## üìä Monitoring

### Logs
- **Startup Logs**: `logs/startup.log`
- **PM2 Logs**: `pm2 logs -f`
- **Application Logs**: `logs/app.log`

### Status Commands
```bash
# Check PM2 status
pm2 status

# Check service health
curl http://192.168.10.128:3001/health

# Check frontend accessibility
curl http://192.168.10.128:3000

# View startup logs
tail -f logs/startup.log
```

## üõ†Ô∏è Troubleshooting

### Common Issues

#### 1. Network Not Ready
```
‚ö†Ô∏è  Network timeout, continuing with localhost
```
**Solution**: Wait for network to be ready or check network configuration

#### 2. Port Already in Use
```
‚ö†Ô∏è  Port 3001 is in use, trying next port...
```
**Solution**: The script automatically finds available ports

#### 3. IP Detection Failure
```
üìç Detected IP: localhost
```
**Solution**: Check network interface configuration

#### 4. CORS Errors
```
Access to fetch at 'http://192.168.10.128:3001/api/system/status' from origin 'http://192.168.10.128:3000' has been blocked by CORS policy
```
**Solution**: Restart services to update CORS configuration

### Debug Commands
```bash
# Check current IP
ip route get 1.1.1.1 | awk '{print $7}'

# Check port availability
lsof -i :3001

# Check PM2 processes
pm2 list

# Check environment variables
cat frontend/.env
cat backend/.env

# Test API connectivity
curl -v http://192.168.10.128:3001/health
```

## üîí Security Considerations

1. **CORS Configuration**: Only allows specific origins
2. **Rate Limiting**: Prevents abuse with configurable limits
3. **Environment Variables**: Sensitive data stored in .env files
4. **Network Binding**: Backend binds to 0.0.0.0 for network access

## üìà Performance

- **Startup Time**: ~10-15 seconds including network detection
- **IP Detection**: Multiple fallback methods for reliability
- **Service Restart**: ~5-10 seconds for configuration updates
- **Memory Usage**: Minimal overhead for IP detection

## üîÑ Future Enhancements

1. **WebSocket IP Detection**: Real-time IP change detection
2. **Load Balancer Support**: Multiple backend instances
3. **SSL/TLS Configuration**: Automatic certificate management
4. **Docker Support**: Containerized deployment with IP detection
5. **Monitoring Dashboard**: Web-based status monitoring

## üìû Support

For issues with the automatic IP detection system:
1. Check the startup logs: `tail -f logs/startup.log`
2. Verify network configuration
3. Test manual startup: `./scripts/start-questa-enhanced.sh`
4. Review this documentation for troubleshooting steps 